<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>决策树管理 - 知识中心</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .management-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            color: #333;
            font-size: 1.5rem;
            margin: 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: #333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 0 5px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
        }
        
        .edit-btn {
            background-color: #007bff;
            color: white;
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 10px;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        .message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 决策树可视化样式 */
        .decision-tree-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            overflow: visible; /* 允许连接线超出容器 */
            position: relative;
            min-height: 500px;
        }
        
        .tree-node {
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: absolute; /* 使用绝对定位 */
            min-width: 180px;
            text-align: center;
            border: 2px solid transparent;
            z-index: 10; /* 确保节点在连接线上方 */
        }
        
        .node.root {
            border-left: 5px solid #28a745;
        }
        
        .node.decision {
            border-left: 5px solid #007bff;
        }
        
        .node.leaf {
            border-left: 5px solid #ffc107;
        }
        
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .node-type {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
        }
        
        .node-type.root {
            background-color: #28a745;
        }
        
        .node-type.decision {
            background-color: #007bff;
        }
        
        .node-type.leaf {
            background-color: #ffc107;
        }
        
        .node-condition, .node-result {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-size: 0.9em;
            text-align: left;
        }
        
        /* 连线样式 */
        .connection-line {
            position: absolute;
            background-color: #6c757d;
            z-index: 1;
        }
        
        .vertical-line {
            width: 2px;
            background-color: #6c757d;
            margin: 0 auto;
        }
        
        .horizontal-line {
            height: 2px;
            background-color: #6c757d;
        }
        
        /* 决策节点分支容器 */
        .decision-branches {
            display: flex;
            justify-content: space-around;
            margin-top: 40px;
            position: relative;
            width: 100%;
        }
        
        .branch-container {
            flex: 1;
            margin: 0 10px;
            padding: 10px;
            min-height: 100px;
            position: relative;
        }
        
        .branch-label {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #007bff;
        }
        
        .branch-content {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .empty-branch, .empty-child {
            text-align: center;
            padding: 10px;
        }
        
        .child-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
        }
        
        .child-connector {
            width: 2px;
            height: 30px;
            background-color: #6c757d;
        }
        
        /* 折叠按钮 */
        .collapse-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        
        /* 展开/折叠图标 */
        .expand-icon::before {
            content: "[-]";
        }
        
        .collapse-icon::before {
            content: "[+]";
        }
        
        /* 根节点子节点容器 */
        .root-children {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* 小屏幕适配 */
        @media (max-width: 768px) {
            .decision-branches {
                flex-direction: column;
            }
            
            .branch-container {
                min-width: unset;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>决策树管理</h1>
            <p>创建和管理决策树模型</p>
        </div>
        
        <div class="management-container">
            <div style="text-align: right; margin-bottom: 20px;">
                <button class="btn" onclick="openCreateTreeModal()">新建决策树</button>
                <button class="btn btn-secondary" onclick="loadTrees()">刷新</button>
            </div>
            
            <div id="message" class="message"></div>
            
            <h2 class="section-title">决策树列表</h2>
            <table id="trees-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>描述</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="trees-list">
                    <!-- 决策树列表将通过JavaScript动态填充 -->
                </tbody>
            </table>
            
            <div id="no-trees-message" style="text-align: center; display: none;">
                <p>暂无决策树，请创建一个新的决策树。</p>
            </div>
        </div>
        
        <a href="/knowledge-center" class="back-link">返回知识中心</a>
    </div>
    
    <!-- 新建/编辑决策树模态框 -->
    <div id="tree-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTreeModal()">&times;</span>
            <h2 id="tree-modal-title">新建决策树</h2>
            <form id="tree-form">
                <input type="hidden" id="tree-id">
                <div class="form-group">
                    <label for="tree-name">决策树名称 *</label>
                    <input type="text" id="tree-name" required>
                </div>
                <div class="form-group">
                    <label for="tree-description">描述</label>
                    <textarea id="tree-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn">保存</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTreeModal()">取消</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 决策树节点管理模态框 -->
    <div id="node-modal" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1200px;">
            <span class="close" onclick="closeNodeModal()">&times;</span>
            <h2 id="node-modal-title">管理节点</h2>
            <div id="node-tree-container">
                <!-- 节点树将在这里显示 -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-secondary" onclick="closeNodeModal()">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 新建/编辑节点模态框 -->
    <div id="create-node-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateNodeModal()">&times;</span>
            <h2 id="create-node-modal-title">新建节点</h2>
            <form id="node-form">
                <input type="hidden" id="node-id">
                <input type="hidden" id="node-tree-id">
                <input type="hidden" id="node-parent-id">
                <input type="hidden" id="node-branch-type"> <!-- 用于标记是/否分支 -->
                <div class="form-group">
                    <label for="node-name">节点名称 *</label>
                    <input type="text" id="node-name" required>
                </div>
                <div class="form-group">
                    <label for="node-type">节点类型 *</label>
                    <select id="node-type" required onchange="toggleNodeTypeFields()">
                        <option value="">请选择节点类型</option>
                        <option value="root">根节点</option>
                        <option value="decision">决策节点</option>
                        <option value="leaf">叶子节点</option>
                    </select>
                </div>
                <div class="form-group" id="condition-field" style="display: none;">
                    <label for="node-condition">判定条件</label>
                    <textarea id="node-condition" rows="3" placeholder="例如: temperature > 30"></textarea>
                </div>
                <div class="form-group" id="result-field" style="display: none;">
                    <label for="node-result">节点结果</label>
                    <textarea id="node-result" rows="3" placeholder="节点的最终结果"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn">保存</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateNodeModal()">取消</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let currentTreeId = null;
        let currentNodeData = {}; // 存储当前节点数据用于编辑
        let nodeStates = {}; // 存储节点展开/折叠状态
        
        // 页面加载时获取决策树列表
        document.addEventListener('DOMContentLoaded', function() {
            loadTrees();
            
            // 绑定表单提交事件
            document.getElementById('tree-form').addEventListener('submit', handleTreeSubmit);
            document.getElementById('node-form').addEventListener('submit', handleNodeSubmit);
        });
        
        // 获取决策树列表
        function loadTrees() {
            fetch('/api/decision-trees')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('trees-list');
                        const noTreesMessage = document.getElementById('no-trees-message');
                        
                        if (data.data.length === 0) {
                            tbody.innerHTML = '';
                            noTreesMessage.style.display = 'block';
                        } else {
                            noTreesMessage.style.display = 'none';
                            tbody.innerHTML = data.data.map(tree => `
                                <tr>
                                    <td>${tree.id}</td>
                                    <td>${tree.name}</td>
                                    <td>${tree.description || ''}</td>
                                    <td>${new Date(tree.created_at).toLocaleString()}</td>
                                    <td>
                                        <button class="action-btn edit-btn" onclick="editTree(${tree.id}, '${tree.name}', '${tree.description || ''}')">编辑</button>
                                        <button class="action-btn" onclick="manageNodes(${tree.id})">管理节点</button>
                                        <button class="action-btn delete-btn" onclick="deleteTree(${tree.id})">删除</button>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    } else {
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('获取决策树列表失败', 'error');
                });
        }
        
        // 显示消息
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
        
        // 打开新建决策树模态框
        function openCreateTreeModal() {
            document.getElementById('tree-modal-title').textContent = '新建决策树';
            document.getElementById('tree-id').value = '';
            document.getElementById('tree-name').value = '';
            document.getElementById('tree-description').value = '';
            document.getElementById('tree-modal').style.display = 'block';
        }
        
        // 编辑决策树
        function editTree(id, name, description) {
            document.getElementById('tree-modal-title').textContent = '编辑决策树';
            document.getElementById('tree-id').value = id;
            document.getElementById('tree-name').value = name;
            document.getElementById('tree-description').value = description;
            document.getElementById('tree-modal').style.display = 'block';
        }
        
        // 关闭决策树模态框
        function closeTreeModal() {
            document.getElementById('tree-modal').style.display = 'none';
        }
        
        // 处理决策树表单提交
        function handleTreeSubmit(e) {
            e.preventDefault();
            
            const id = document.getElementById('tree-id').value;
            const name = document.getElementById('tree-name').value;
            const description = document.getElementById('tree-description').value;
            
            const data = { name, description };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/decision-trees/${id}` : '/api/decision-trees';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeTreeModal();
                    loadTrees();
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('操作失败', 'error');
            });
        }
        
        // 删除决策树
        function deleteTree(id) {
            if (!confirm('确定要删除该决策树吗？此操作不可恢复。')) {
                return;
            }
            
            fetch(`/api/decision-trees/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    loadTrees();
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('删除失败', 'error');
            });
        }
        
        // 管理节点
        function manageNodes(treeId) {
            currentTreeId = treeId;
            nodeStates = {}; // 重置节点状态
            loadTreeNodes(treeId);
            document.getElementById('node-modal').style.display = 'block';
        }
        
        // 加载决策树节点
        function loadTreeNodes(treeId) {
            fetch(`/api/decision-trees/${treeId}/nodes`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTreeNodes(data.data, treeId);
                    } else {
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('获取节点失败', 'error');
                });
        }
        
        // 渲染决策树节点
        function renderTreeNodes(nodes, treeId) {
            const container = document.getElementById('node-tree-container');
            
            if (nodes.length === 0) {
                container.innerHTML = `
                    <div class="empty-tree">
                        <p>该决策树暂无节点，请添加根节点开始构建决策树。</p>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="openCreateNodeModal(${treeId}, null, null)">添加根节点</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // 找到根节点
            const rootNode = nodes.find(node => node.node_type === 'root');
            if (!rootNode) {
                container.innerHTML = '<p>未找到根节点</p>';
                return;
            }
            
            // 渲染整个决策树
            container.innerHTML = `
                <div class="decision-tree-container" id="tree-container">
                    ${renderTreeNode(rootNode, nodes)}
                </div>
            `;
            
            // 绘制连接线
            setTimeout(() => drawTreeConnections(rootNode, nodes), 100);
        }
        
        // 渲染决策树
        function renderDecisionTree(rootNode, allNodes) {
            // 使用递归方式渲染树
            let html = '<div class="tree-layout">';
            html += renderTreeNode(rootNode, allNodes);
            html += '</div>';
            return html;
        }
        
        // 递归渲染节点 - 连线模式
        function renderTreeNode(node, allNodes, positions = { x: 500, y: 50 }, level = 0, index = 0) {
            // 检查节点是否应该展开
            const isExpanded = nodeStates[node.id] !== false; // 默认展开
            
            // 计算节点位置
            const nodePositions = calculateNodePosition(node, allNodes, positions, level, index);
            
            let html = `
                <div class="tree-node ${node.node_type}" id="node-${node.id}" 
                     style="left: ${nodePositions.x}px; top: ${nodePositions.y}px;">
                    <div class="node-header">
                        <div>
                            <strong>${node.name}</strong>
                            <span class="node-type ${node.node_type}">${getNodeTypeName(node.node_type)}</span>
                        </div>
                        <div>
                            <button class="action-btn edit-btn" onclick="editNode(${JSON.stringify(node).replace(/"/g, '&quot;')})">编辑</button>
                            <button class="action-btn delete-btn" onclick="deleteNode(${node.id})">删除</button>
                            ${(node.node_type === 'decision') ? `<button class="collapse-btn ${isExpanded ? 'expand-icon' : 'collapse-icon'}" onclick="toggleNode(${node.id})"></button>` : ''}
                        </div>
                    </div>
            `;
            
            if (node.condition) {
                html += `<div class="node-condition"><strong>判定条件:</strong> ${node.condition}</div>`;
            }
            
            if (node.result) {
                html += `<div class="node-result"><strong>节点结果:</strong> ${node.result}</div>`;
            }
            
            // 特殊处理决策节点，显示左右分支占位符（如果已折叠则不显示）
            if (node.node_type === 'decision' && isExpanded) {
                // 查找是分支和否分支的子节点
                const yesChild = allNodes.find(n => n.id === node.yes_child_id);
                const noChild = allNodes.find(n => n.id === node.no_child_id);
                
                html += `
                    <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                        <div style="text-align: center;">
                            ${yesChild ? '' : `
                                <div class="branch-placeholder">
                                    <div style="margin-bottom: 5px; color: #007bff; font-weight: bold;">是</div>
                                    <button class="btn" style="margin-top: 5px; padding: 3px 8px; font-size: 12px;" 
                                        onclick="openCreateNodeModal(${node.tree_id}, ${node.id}, 'decision', 'yes')">添加节点</button>
                                </div>
                            `}
                        </div>
                        <div style="text-align: center;">
                            ${noChild ? '' : `
                                <div class="branch-placeholder">
                                    <div style="margin-bottom: 5px; color: #dc3545; font-weight: bold;">否</div>
                                    <button class="btn" style="margin-top: 5px; padding: 3px 8px; font-size: 12px;" 
                                        onclick="openCreateNodeModal(${node.tree_id}, ${node.id}, 'decision', 'no')">添加节点</button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } else if (node.node_type === 'decision' && !isExpanded) {
                // 节点已折叠，显示展开按钮
                html += `<div style="text-align: center; margin-top: 10px;"><small>节点已折叠</small></div>`;
            } else if (node.node_type === 'root') {
                // 根节点检查是否有子节点的占位符
                const childNodes = allNodes.filter(n => n.parent_id === node.id);
                if (childNodes.length === 0) {
                    html += `
                        <div style="text-align: center; margin-top: 10px;">
                            <button class="btn" style="padding: 3px 8px; font-size: 12px;" 
                                onclick="addChildNode(${node.tree_id}, ${node.id}, '${node.node_type}')">添加子节点</button>
                        </div>
                    `;
                }
            }
            
            html += `</div>`;
            
            // 递归渲染子节点（但不在DOM结构中嵌套）
            if (isExpanded) {
                if (node.node_type === 'decision') {
                    const yesChild = allNodes.find(n => n.id === node.yes_child_id);
                    const noChild = allNodes.find(n => n.id === node.no_child_id);
                    
                    if (yesChild) {
                        html += renderTreeNode(yesChild, allNodes, null, level + 1, 0);
                    }
                    if (noChild) {
                        html += renderTreeNode(noChild, allNodes, null, level + 1, 1);
                    }
                } else if (node.node_type === 'root') {
                    const childNodes = allNodes.filter(n => n.parent_id === node.id);
                    childNodes.forEach((child, idx) => {
                        html += renderTreeNode(child, allNodes, null, level + 1, idx);
                    });
                }
            }
            
            return html;
        }
        
        // 计算节点位置
        function calculateNodePosition(node, allNodes, positions, level, index) {
            // 如果已经提供了位置，则直接使用
            if (positions) {
                return positions;
            }
            
            // 根节点居中显示在顶部
            if (node.node_type === 'root') {
                return { x: 500, y: 50 };
            }
            
            // 查找父节点
            const parentNode = allNodes.find(n => 
                n.id === node.parent_id || 
                n.yes_child_id === node.id || 
                n.no_child_id === node.id
            );
            
            if (!parentNode) {
                // 如果找不到父节点，默认位置
                return { x: 100 + index * 300, y: 100 + level * 150 };
            }
            
            // 获取父节点的位置
            const parentElement = document.getElementById(`node-${parentNode.id}`);
            let parentPos;
            
            if (parentElement) {
                // 如果父节点已在DOM中，获取其实际位置
                parentPos = { 
                    x: parseInt(parentElement.style.left) || 0, 
                    y: parseInt(parentElement.style.top) || 0 
                };
            } else {
                // 否则计算父节点位置
                parentPos = calculateNodePosition(parentNode, allNodes, null, level - 1, index);
            }
            
            // 根据节点类型和索引计算位置
            if (parentNode.node_type === 'decision') {
                // 决策节点的子节点放在下方左右两侧
                const xOffset = parentNode.yes_child_id === node.id ? -250 : 250;
                return { 
                    x: parentPos.x + xOffset, 
                    y: parentPos.y + 200 
                };
            } else {
                // 根节点的子节点居中排列
                return { 
                    x: parentPos.x - 100 + index * 200, 
                    y: parentPos.y + 150 
                };
            }
        }
        
        // 渲染单个决策树节点
        function renderDecisionTreeNode(node, allNodes) {
            // 不再使用此函数，但保留以防止其他地方调用
            return renderTreeNode(node, allNodes);
        }
        
        // 渲染分支节点（保留以确保兼容性）
        function renderBranchNode(node, allNodes) {
            // 不再使用此函数，但保留以防止其他地方调用
            return renderTreeNode(node, allNodes);
        }
        
        // 添加子节点
        function addChildNode(treeId, parentId, parentType) {
            openCreateNodeModal(treeId, parentId, parentType);
        }
        
        // 切换节点展开/折叠状态
        function toggleNode(nodeId) {
            nodeStates[nodeId] = !nodeStates[nodeId];
            loadTreeNodes(currentTreeId); // 重新渲染树
        }
        
        // 获取节点类型名称
        function getNodeTypeName(type) {
            switch(type) {
                case 'root': return '根节点';
                case 'decision': return '决策节点';
                case 'leaf': return '叶子节点';
                default: return type;
            }
        }
        
        // 关闭节点管理模态框
        function closeNodeModal() {
            document.getElementById('node-modal').style.display = 'none';
        }
        
        // 打开创建节点模态框
        function openCreateNodeModal(treeId, parentId = null, parentType = null, branchType = null) {
            document.getElementById('create-node-modal-title').textContent = parentId ? '新建子节点' : '新建根节点';
            document.getElementById('node-id').value = '';
            document.getElementById('node-tree-id').value = treeId;
            document.getElementById('node-parent-id').value = parentId || '';
            document.getElementById('node-branch-type').value = branchType || ''; // 记录分支类型
            document.getElementById('node-name').value = '';
            document.getElementById('node-type').value = '';
            document.getElementById('node-condition').value = '';
            document.getElementById('node-result').value = '';
            
            // 根据父节点类型设置节点类型选项
            const typeSelect = document.getElementById('node-type');
            typeSelect.innerHTML = '<option value="">请选择节点类型</option>';
            
            if (parentId === null) {
                // 根节点
                typeSelect.innerHTML += '<option value="root">根节点</option>';
                document.getElementById('condition-field').style.display = 'none';
                document.getElementById('result-field').style.display = 'none';
            } else if (parentType === 'decision') {
                // 决策节点的分支只能是决策节点或叶子节点
                typeSelect.innerHTML += '<option value="decision">决策节点</option>';
                typeSelect.innerHTML += '<option value="leaf">叶子节点</option>';
            } else if (parentType === 'root') {
                // 根节点的子节点只能是决策节点或叶子节点
                typeSelect.innerHTML += '<option value="decision">决策节点</option>';
                typeSelect.innerHTML += '<option value="leaf">叶子节点</option>';
            } else {
                // 其他情况可以添加决策节点或叶子节点
                typeSelect.innerHTML += '<option value="decision">决策节点</option>';
                typeSelect.innerHTML += '<option value="leaf">叶子节点</option>';
            }
            
            // 如果是决策节点的分支，预设节点类型
            if (branchType === 'yes' || branchType === 'no') {
                // 对于分支节点，可以是决策节点或叶子节点
                typeSelect.value = 'decision'; // 默认为决策节点
                toggleNodeTypeFields();
            }
            
            document.getElementById('create-node-modal').style.display = 'block';
        }
        
        // 编辑节点
        function editNode(nodeData) {
            currentNodeData = nodeData; // 保存节点数据用于更新
            
            document.getElementById('create-node-modal-title').textContent = '编辑节点';
            document.getElementById('node-id').value = nodeData.id;
            document.getElementById('node-tree-id').value = nodeData.tree_id;
            document.getElementById('node-parent-id').value = nodeData.parent_id || '';
            document.getElementById('node-name').value = nodeData.name;
            document.getElementById('node-type').value = nodeData.node_type;
            
            // 设置条件和结果字段
            document.getElementById('node-condition').value = nodeData.condition || '';
            document.getElementById('node-result').value = nodeData.result || '';
            
            // 根据节点类型显示相应字段
            toggleNodeTypeFields();
            
            document.getElementById('create-node-modal').style.display = 'block';
        }
        
        // 删除节点
        function deleteNode(nodeId) {
            if (!confirm('确定要删除该节点吗？此操作将同时删除所有子节点。')) {
                return;
            }
            
            fetch(`/api/decision-tree-nodes/${nodeId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    loadTreeNodes(currentTreeId);
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('删除节点失败', 'error');
            });
        }
        
        // 关闭创建节点模态框
        function closeCreateNodeModal() {
            document.getElementById('create-node-modal').style.display = 'none';
        }
        
        // 切换节点类型字段显示
        function toggleNodeTypeFields() {
            const type = document.getElementById('node-type').value;
            const conditionField = document.getElementById('condition-field');
            const resultField = document.getElementById('result-field');
            
            conditionField.style.display = (type === 'decision') ? 'block' : 'none';
            resultField.style.display = (type === 'leaf') ? 'block' : 'none';
        }
        
        // 处理节点表单提交
        function handleNodeSubmit(e) {
            e.preventDefault();
            
            const id = document.getElementById('node-id').value;
            const tree_id = document.getElementById('node-tree-id').value;
            const parent_id = document.getElementById('node-parent-id').value;
            const branch_type = document.getElementById('node-branch-type').value; // 分支类型（yes/no）
            const name = document.getElementById('node-name').value;
            const node_type = document.getElementById('node-type').value;
            const condition = document.getElementById('node-condition').value;
            const result = document.getElementById('node-result').value;
            
            const data = { tree_id, name, node_type };
            
            if (parent_id) data.parent_id = parent_id;
            if (condition) data.condition = condition;
            if (result) data.result = result;
            
            // 如果是决策节点的分支，记录分支信息
            if (parent_id && branch_type) {
                data.branch_type = branch_type; // 'yes' 或 'no'
            }
            
            const method = id ? 'PUT' : 'POST';
            let url = id ? `/api/decision-tree-nodes/${id}` : '/api/decision-tree-nodes';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 如果是决策节点的分支，需要更新父节点的yes_child_id或no_child_id
                    if (parent_id && branch_type && data.data) {
                        updateParentBranch(parent_id, data.data.id, branch_type)
                            .then(() => {
                                showMessage('节点创建成功', 'success');
                                closeCreateNodeModal();
                                loadTreeNodes(tree_id);
                            })
                            .catch(() => {
                                showMessage('节点创建成功，但分支关联失败', 'error');
                                closeCreateNodeModal();
                                loadTreeNodes(tree_id);
                            });
                    } else {
                        showMessage(data.message, 'success');
                        closeCreateNodeModal();
                        loadTreeNodes(tree_id);
                    }
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('操作失败', 'error');
            });
        }
        
        // 更新父节点的分支关联
        function updateParentBranch(parentId, childId, branchType) {
            // 不再需要这个函数，因为在后端已经处理了分支关联
            return Promise.resolve();
        }
        
        // 渲染节点头部
        function renderNodeHeader(node) {
            return `
                <div class="node-header">
                    <div>
                        <strong>${node.name}</strong>
                        <span class="node-type ${node.node_type}">${getNodeTypeName(node.node_type)}</span>
                    </div>
                    <div class="node-actions">
                        <button class="action-btn edit-btn" onclick="editNode(${JSON.stringify(node).replace(/"/g, '&quot;')})">编辑</button>
                        <button class="action-btn delete-btn" onclick="deleteNode(${node.id})">删除</button>
                    </div>
                </div>
            `;
        }
        
        // 渲染节点详细信息
        function renderNodeDetails(node) {
            let html = '';
            
            if (node.condition) {
                html += `<div class="node-condition"><strong>判定条件:</strong> ${node.condition}</div>`;
            }
            
            if (node.result) {
                html += `<div class="node-result"><strong>节点结果:</strong> ${node.result}</div>`;
            }
            
            return html;
        }
        
        // 绘制连接线
        function drawConnectionLines() {
            // 移除之前的所有连线
            const existingLines = document.querySelectorAll('.connection-line');
            existingLines.forEach(line => line.remove());
            
            // 获取所有节点元素
            const nodeElements = document.querySelectorAll('[id^="tree-node-"]');
            
            nodeElements.forEach(nodeElement => {
                const nodeId = parseInt(nodeElement.id.replace('tree-node-', ''));
                
                // 查找节点数据
                fetch(`/api/decision-tree-nodes/${nodeId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const node = data.data;
                            
                            if (node.node_type === 'decision') {
                                // 决策节点绘制到子节点的连线
                                drawLineToChild(node, node.yes_child_id);
                                drawLineToChild(node, node.no_child_id);
                            } else if (node.node_type === 'root') {
                                // 根节点绘制到子节点的连线
                                const container = document.getElementById('node-tree-container');
                                if (container) {
                                    const childNodes = Array.from(container.querySelectorAll('[id^="tree-node-"]'))
                                        .filter(el => {
                                            const id = parseInt(el.id.replace('tree-node-', ''));
                                            return data.allNodes && data.allNodes.some(n => n.parent_id === node.id && n.id === id);
                                        });
                                    
                                    if (childNodes.length > 0) {
                                        drawLineToChild(node, childNodes[0].id.replace('tree-node-', ''));
                                    }
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching node data:', error));
            });
        }
        
        // 绘制到子节点的连线
        function drawLineToChild(parentNode, childId, branchLabel, container) {
            if (!childId) return;
            
            const parentElement = document.getElementById(`tree-node-${parentNode.id}`);
            const childElement = document.getElementById(`tree-node-${childId}`);
            
            if (!parentElement || !childElement) return;
            
            const parentRect = parentElement.getBoundingClientRect();
            const childRect = childElement.getBoundingClientRect();
            
            const containerRect = container.getBoundingClientRect();
            
            // 计算相对位置
            const parentX = parentRect.left - containerRect.left + parentRect.width / 2;
            const parentY = parentRect.top - containerRect.top + parentRect.height;
            const childX = childRect.left - containerRect.left + childRect.width / 2;
            const childY = childRect.top - containerRect.top;
            
            // 创建水平线
            const horizontalLine = document.createElement('div');
            horizontalLine.className = 'connection-line horizontal-line';
            horizontalLine.style.width = Math.abs(childX - parentX) + 'px';
            horizontalLine.style.left = Math.min(parentX, childX) + 'px';
            horizontalLine.style.top = parentY + 'px';
            
            // 创建垂直线
            const verticalLine = document.createElement('div');
            verticalLine.className = 'connection-line vertical-line';
            verticalLine.style.height = (childY - parentY) + 'px';
            verticalLine.style.left = childX + 'px';
            verticalLine.style.top = parentY + 'px';
            
            // 创建分支标签
            if (branchLabel) {
                // 检查是否已存在相同标签
                const existingLabels = container.querySelectorAll('.branch-label-line');
                let hasExistingLabel = false;
                
                existingLabels.forEach(label => {
                    if (label.textContent === branchLabel) {
                        hasExistingLabel = true;
                    }
                });
                
                if (!hasExistingLabel) {
                    const labelElement = document.createElement('div');
                    labelElement.className = 'branch-label-line';
                    labelElement.textContent = branchLabel;
                    labelElement.style.left = (Math.min(parentX, childX) + 5) + 'px';
                    labelElement.style.top = (parentY - 20) + 'px';
                    container.appendChild(labelElement);
                }
            }
            
            container.appendChild(horizontalLine);
            container.appendChild(verticalLine);
        }

        // 绘制树连接线
        function drawTreeConnections(rootNode, allNodes) {
            // 移除之前的所有连线
            const existingLines = document.querySelectorAll('.connection-line, .branch-label-line');
            existingLines.forEach(line => line.remove());
            
            const container = document.querySelector('.decision-tree-container');
            if (!container) return;
            
            // 遍历所有节点，绘制与子节点的连线
            function drawConnections(node) {
                const nodeElement = document.getElementById(`node-${node.id}`);
                if (!nodeElement) return;
                
                if (node.node_type === 'decision') {
                    // 决策节点绘制到子节点的连线
                    const yesChild = allNodes.find(n => n.id === node.yes_child_id);
                    const noChild = allNodes.find(n => n.id === node.no_child_id);
                    
                    if (yesChild) {
                        drawLineToChild(node, yesChild, '是', container);
                        drawConnections(yesChild);
                    }
                    
                    if (noChild) {
                        drawLineToChild(node, noChild, '否', container);
                        drawConnections(noChild);
                    }
                } else if (node.node_type === 'root') {
                    // 根节点绘制到子节点的连线
                    const children = allNodes.filter(n => n.parent_id === node.id);
                    children.forEach(child => {
                        drawLineToChild(node, child, '', container);
                        drawConnections(child);
                    });
                } else if (node.node_type === 'leaf') {
                    // 叶子节点没有子节点
                    return;
                }
            }
            
            drawConnections(rootNode);
        }
        
        // 绘制到子节点的连线
        function drawLineToChild(parentNode, childNode, branchLabel, container) {
            const parentElement = document.getElementById(`node-${parentNode.id}`);
            const childElement = document.getElementById(`node-${childNode.id}`);
            
            if (!parentElement || !childElement) return;
            
            // 获取父节点和子节点的位置
            const parentLeft = parseInt(parentElement.style.left) || 0;
            const parentTop = parseInt(parentElement.style.top) || 0;
            const parentWidth = parentElement.offsetWidth;
            const parentHeight = parentElement.offsetHeight;
            
            const childLeft = parseInt(childElement.style.left) || 0;
            const childTop = parseInt(childElement.style.top) || 0;
            const childWidth = childElement.offsetWidth;
            const childHeight = childElement.offsetHeight;
            
            // 计算连接点位置
            const parentConnectX = parentLeft + parentWidth / 2;
            const parentConnectY = parentTop + parentHeight;
            const childConnectX = childLeft + childWidth / 2;
            const childConnectY = childTop;
            
            // 创建垂直线（从父节点到底部）
            const verticalLine = document.createElement('div');
            verticalLine.className = 'connection-line vertical-line';
            verticalLine.style.position = 'absolute';
            verticalLine.style.width = '2px';
            verticalLine.style.height = Math.abs(childConnectY - parentConnectY) + 'px';
            verticalLine.style.left = (parentConnectX - 1) + 'px';
            verticalLine.style.top = parentConnectY + 'px';
            verticalLine.style.backgroundColor = '#6c757d';
            verticalLine.style.zIndex = '1';
            container.appendChild(verticalLine);
            
            // 创建水平线（从垂直线到子节点）
            const horizontalLine = document.createElement('div');
            horizontalLine.className = 'connection-line horizontal-line';
            horizontalLine.style.position = 'absolute';
            horizontalLine.style.height = '2px';
            horizontalLine.style.width = Math.abs(childConnectX - parentConnectX) + 'px';
            horizontalLine.style.left = Math.min(parentConnectX, childConnectX) + 'px';
            horizontalLine.style.top = (childConnectY - 1) + 'px';
            horizontalLine.style.backgroundColor = '#6c757d';
            horizontalLine.style.zIndex = '1';
            container.appendChild(horizontalLine);
            
            // 创建分支标签
            if (branchLabel) {
                const labelElement = document.createElement('div');
                labelElement.className = 'branch-label-line';
                labelElement.textContent = branchLabel;
                labelElement.style.position = 'absolute';
                labelElement.style.fontSize = '12px';
                labelElement.style.color = branchLabel === '是' ? '#007bff' : '#dc3545';
                labelElement.style.fontWeight = 'bold';
                labelElement.style.zIndex = '1';
                labelElement.style.backgroundColor = '#f8f9fa';
                labelElement.style.padding = '0 5px';
                labelElement.style.borderRadius = '3px';
                
                // 根据分支类型设置位置
                if (branchLabel === '是') {
                    // "是"分支标签放在垂直线左侧
                    labelElement.style.left = (parentConnectX - 20) + 'px';
                    labelElement.style.top = (parentConnectY + 5) + 'px';
                } else {
                    // "否"分支标签放在垂直线右侧
                    labelElement.style.left = (parentConnectX + 15) + 'px';
                    labelElement.style.top = (parentConnectY + 5) + 'px';
                }
                
                container.appendChild(labelElement);
            }
        }
    </script>
</body>
</html>